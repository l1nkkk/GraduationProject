# 意义
- 系统拆分成多个独立模块，扩大了系统的攻击面，容易其中一个服务被当成跳板
- 进程见的通信变为了服务模块间的通信，其通信安全性难以得到保证
- 模块之间每次接收消息都不对消息源进行确认，这种信任关系很容易被利用
- 服务模块结构松散，难以统一管理，出现异常无法及时响应，并且问题定位会花很多时间

# 功能
- 密钥分发方案
- 微服务访问控制机制---限制微服务的访问范围
- 日志监控与分析---微服务的管理监控
- 传输协议定义---完成对传输信息的保密性和完整性的保护工作
# 认证与秘钥分发模块的设计
加密的安全前提：秘钥的安全为前提，安全的秘钥分发做保证

秘钥体系选择：对称加密，因为效率高。

身份认证：周期性地挑战应答来完成客户端微服务的身份认证；也就是说客户端微服务与认证控制中心进行挑战应答，以完成自己身份认证并得到属于自己的会话密钥。存在重放攻击风险

## 具体实现
客户端C微服务会与认证控制中心S共享一个密钥K，以配置文件的方式初始化到微服务

|           标识            |             表示             |
| :-----------------------: | :--------------------------: |
|             C             |            微服务客户端            |
|             S             |         认证控制中心         |
|             K             |        C与S共享的密钥        |
|            IDc            | 在注册发现中心注册的微服务名 |
|            Tc             |            时间戳            |
|            Ts             |            时间戳            |
| N | 随机数挑战码 |
| Authenticator<sub>s</sub> |   HMAC<sub>K</sub>(N, Ts)    |
| Authenticator<sub>c</sub> | HMAC<sub>K</sub>(N, Tc) |
| E |  对称加密 |
| hash | 哈希 | 
| SK  | 准备分配给C的会话密钥  |


1. C -> S : IDc || TC
2. S去同一个注册中心检索该微服务名IDc，确定合法后再进行下一步操作。
3. S -> C : Ts || N || Authenticator<sub>s</sub>
4. C收到之后使用挑战码N和Ts进行相同HMAC摘要计算，并与服务器验证信息进行比对，检查计算结果是否一致验证认证控制中心的身份。**至此S的身份认证完成**
5. C -> S : Tc || Authenticator<sub>c</sub>，同4操作，**完成对C的身份认证**
6. S -> C : E<sub>hash(N,K)</sub>(Tc+1, SK)
7. C解密得到密钥，**现在可以使用SK直接和目标微服务发起通信**


# 数据安全通信模块设计
|           标识            |             表示             |
| :-----------------------: | :--------------------------: |
|             C             |            微服务客户端            |
|             A             |         微服务A         |
|            B             |        微服务B        |