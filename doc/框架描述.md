# 微服务之间的调用
<center>
<img src="pic/微服务之间的交互.png">
</center>

- `A-->B(API)`：当微服务A调用服务B的API的时候，先用A的会话密钥SKa对相应敏感信息进行加密。然后发送给服务B
- `认证和获取会话密钥`：B收到API调用后会调用ACC的API对其进行认证以及获取A的会话密钥同时完成了对A的认证。API为：`http://127.0.0.1:8080/acc/secrectKey`
- `鉴权`：查看自己缓存在内存中的权限表，看看该微服务(用户)是否具有这个权限
- `解密`：用A的会话密钥解密被加密部分，进入API处理
- `加密并返回`：用A的会话秘钥SKa对其响应进行的一些部分进行加密，然后返回给微服务A，至此整个调用过程结束。

# 向认证模块获取自身会话密钥
上面的服务A是如何获得会话密钥的，过程如下

<center>
<img src="pic/向认证模块获取自身会话密钥.png">
</center>

- 当每个服务启动的时候，会向注册中心(etcd,一款数据库)中写入自己的注册信息，完成微服务注册。
- 每隔两分钟**业务微服务**会发起挑战应答，其中需要调用`http://127.0.0.1:8080/acc/request_auth`，业务微服务接收响应之后C和S双方已经完成双向认证。
- 之后**业务微服务**调用`http://127.0.0.1:8080/acc/client_auth`获取自己的会话密钥，用于调用其他服务API



## 具体实现
客户端C微服务会与认证控制中心S共享一个密钥K，以配置文件的方式初始化到微服务

|           标识            |             表示             |
| :-----------------------: | :--------------------------: |
|             C             |         微服务客户端         |
|             S             |         认证控制中心         |
|             K             |        C与S共享的密钥        |
|            IDc            | 在注册发现中心注册的微服务名 |
|            Tc             |            时间戳            |
|            Ts             |            时间戳            |
|             N             |         随机数挑战码         |
| Authenticator<sub>s</sub> |   HMAC<sub>K</sub>(N, Ts)    |
| Authenticator<sub>c</sub> |   HMAC<sub>K</sub>(N, Tc)    |
|             E             |           对称加密           |
|           hash            |             哈希             |
|            SK             |    准备分配给C的会话密钥     |

注：
- HMAC<sub>K</sub>(N, Ts)：表示使用公共密钥K进行HMAC摘要计算
- 会话密钥随着挑战应答，两分钟更换一次
- 如何确保认证中心安全是一个问题
1. C -> S : IDc || TC
2. S去同一个注册中心检索该微服务insID，和微服务类class，确定合法后再进行下一步操作。
3. S -> C : Ts || N || Authenticator<sub>s</sub>
4. C收到之后使用挑战码N和Ts进行相同HMAC摘要计算，并与服务器验证信息进行比对，检查计算结果是否一致验证认证控制中心的身份。**至此S的身份认证完成**
5. C -> S : Tc || Authenticator<sub>c</sub>，同4操作，**完成对C的身份认证**
6. S -> C : E<sub>hash(N,K)</sub>(Tc+1, SK)
7. C解密得到密钥，**现在可以使用SK直接和目标微服务发起通信**

## 鉴权

pass


# 微服务注册和获取微服务信息


<center>
<img src="pic/微服务注册和获取.png">
</center>

> etcd中的数据实例大致如下

| key                             |      value       |
| :------------------------------: | :--------------: |
| /instance/Container/Container-1 | 192.168.3.2:8000 |
| /instance/web/web-1             | 192.168.3.4:3000 |